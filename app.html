<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gestionale</title>
  <style>
:root {
  --border: #e5e5e5;
  --text: #111;
  --muted: #666;
  --danger: #d7263d;
  --bg: #fff;
  --overlay: rgba(0,0,0,0.45);
}

body {
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  margin: 0;
  padding: 0;
  color: var(--text);
  background: #fafafa;
}

.topbar {
  position: sticky;
  top: 0;
  z-index: 10;
  background: var(--bg);
  border-bottom: 1px solid var(--border);
  padding: 14px 18px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.title {
  margin: 0;
  font-size: 18px;
  font-weight: 700;
}

.topbar-actions {
  display: flex;
  gap: 10px;
  align-items: center;
}

.fab {
  width: 42px;
  height: 42px;
  border-radius: 999px;
  border: 0;
  cursor: pointer;
  background: var(--danger);
  color: #fff;
  font-size: 24px;
  line-height: 42px;
  display: grid;
  place-items: center;
}

.panel {
  padding: 18px;
}

.cards {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
  gap: 12px;
}

.card {
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 14px;
  background: var(--bg);
}

.card h4 {
  margin: 0 0 10px 0;
  font-size: 16px;
}

.card .row {
  display: flex;
  justify-content: space-between;
  gap: 10px;
  margin: 6px 0;
  font-size: 14px;
}

.muted {
  color: var(--muted);
  font-size: 12px;
}

/* Modal */
.overlay {
  position: fixed;
  inset: 0;
  background: var(--overlay);
  display: grid;
  place-items: center;
  padding: 18px;
}

.hidden { display: none; }

.modal {
  width: min(520px, 100%);
  background: var(--bg);
  border-radius: 16px;
  border: 1px solid var(--border);
  box-shadow: 0 10px 30px rgba(0,0,0,0.18);
  overflow: hidden;
}

.modal-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 16px;
  border-bottom: 1px solid var(--border);
}

.modal-head h2 {
  margin: 0;
  font-size: 16px;
}

.icon-btn {
  border: 0;
  background: transparent;
  cursor: pointer;
  font-size: 18px;
  padding: 8px 10px;
  border-radius: 10px;
}

.form {
  padding: 16px;
  display: grid;
  gap: 12px;
}

.form label {
  display: grid;
  gap: 6px;
  font-size: 13px;
  color: var(--text);
}

.form input {
  padding: 10px 12px;
  border: 1px solid var(--border);
  border-radius: 12px;
  outline: none;
  font-size: 14px;
  background: #fff;
}

.form input:focus {
  border-color: #c9c9c9;
}

.msg {
  min-height: 18px;
  font-size: 13px;
  color: #b00020;
}

.form-actions {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  margin-top: 4px;
}

.btn {
  border: 1px solid var(--border);
  background: #fff;
  padding: 10px 12px;
  border-radius: 12px;
  cursor: pointer;
}

.btn.primary {
  border: 0;
  background: #111;
  color: #fff;
}
.card-actions {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
  margin-top: 10px;
}

.small-btn {
  border: 1px solid var(--border);
  background: #fff;
  padding: 8px 10px;
  border-radius: 12px;
  cursor: pointer;
  font-size: 13px;
}
.danger-btn {
  border: 0;
  background: var(--danger);
  color: #fff;
  width: 34px;
  height: 34px;
  border-radius: 12px;
  cursor: pointer;
  font-size: 16px;
  display: grid;
  place-items: center;
}
.card-image {
  width: 100%;
  height: 160px;
  overflow: hidden;
  border-radius: 12px;
  margin-bottom: 10px;
  background: #f2f2f2;
}

.card-image img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}


  </style>
</head>

<body>
<header class="topbar">
  <h1 class="title">Tutti i prodotti</h1>

  <div class="topbar-actions">
    <button id="addBtn" class="fab" type="button" aria-label="Aggiungi prodotto">+</button>
  </div>
</header>

<main>
  <section class="panel">
    <div id="stockBox" class="cards"></div>
  </section>
</main>
<!-- MODAL EDIT QTY -->
<div id="editOverlay" class="overlay hidden" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="editTitle">
    <div class="modal-head">
      <h2 id="editTitle">Modifica quantità</h2>
      <button id="closeEditBtn" class="icon-btn" type="button" aria-label="Chiudi">✕</button>
    </div>

    <form id="editForm" class="form">
      <div class="muted" id="editProductName"></div>

      <input id="editId" type="hidden" />

      <label>
        Nuova quantità
        <input id="editQty" type="number" step="0.01" min="0" required />
      </label>

      <div id="editMsg" class="msg"></div>

      <div class="form-actions">
        <button id="cancelEditBtn" type="button" class="btn">Annulla</button>
        <button type="submit" class="btn primary">Salva</button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL -->
<div id="modalOverlay" class="overlay hidden" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-head">
      <h2 id="modalTitle">Nuovo prodotto</h2>
      <button id="closeModalBtn" class="icon-btn" type="button" aria-label="Chiudi">✕</button>
    </div>
    <label>
  Immagine prodotto
  <input id="imageFile" type="file" accept="image/*">
</label>

    <form id="productForm" class="form">
      <label>
        Nome prodotto
        <input id="name" type="text" placeholder="Es. Caffè" required />
      </label>

      <label>
        Prezzo pagato
        <input id="price" type="number" step="0.01" min="0" placeholder="Es. 12.50" required />
      </label>

      <label>
        Quantità acquistata
        <input id="qty" type="number" step="0.01" min="0" placeholder="Es. 5" required />
      </label>

      <div id="formMsg" class="msg"></div>

      <div class="form-actions">
        <button id="cancelBtn" type="button" class="btn">Annulla</button>
        <button id="saveBtn" type="submit" class="btn primary">Salva</button>
      </div>
    </form>
  </div>
</div>

</body>
 <script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const SUPABASE_URL = "https://vrxctmrnumkzswdnvjbp.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZyeGN0bXJudW1renN3ZG52amJwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MzM3ODIsImV4cCI6MjA4MjQwOTc4Mn0.FTNv23yGcLvDKKa2hyP9lj2sFeTUB6iFMzU4G_7AUMU";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Require auth
  const { data: { session } } = await supabase.auth.getSession();
  if (!session) window.location.href = "./index.html";

  // DOM
  const stockBox = document.getElementById("stockBox");

  const addBtn = document.getElementById("addBtn");
  const overlay = document.getElementById("modalOverlay");
  const closeModalBtn = document.getElementById("closeModalBtn");
  const cancelBtn = document.getElementById("cancelBtn");

  const form = document.getElementById("productForm");
  const msg = document.getElementById("formMsg");

  const nameEl = document.getElementById("name");
  const priceEl = document.getElementById("price");
  const qtyEl = document.getElementById("qty");

const editOverlay = document.getElementById("editOverlay");
const closeEditBtn = document.getElementById("closeEditBtn");
const cancelEditBtn = document.getElementById("cancelEditBtn");
const editForm = document.getElementById("editForm");
const editId = document.getElementById("editId");
const editQty = document.getElementById("editQty");
const editMsg = document.getElementById("editMsg");
const editProductName = document.getElementById("editProductName");


const imageFile = document.getElementById("imageFile");

function openEditModal({ id, name, qty }) {
  editOverlay.classList.remove("hidden");
  editOverlay.setAttribute("aria-hidden", "false");
  editMsg.textContent = "";
  editId.value = id;
  editQty.value = qty;
  editProductName.textContent = `Prodotto: ${name}`;
  setTimeout(() => editQty.focus(), 0);
}

editForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  editMsg.textContent = "";

  const id = editId.value;
  const newQty = Number(editQty.value);

  if (!id) {
    editMsg.textContent = "ID mancante.";
    return;
  }
  if (!Number.isFinite(newQty) || newQty < 0) {
    editMsg.textContent = "Quantità non valida.";
    return;
  }
//eccoeccoecco
let image_url = null;

if (imageFile.files.length > 0) {
  const file = imageFile.files[0];
  const ext = file.name.split(".").pop() || "jpg";
  const filePath = `products/${crypto.randomUUID()}.${ext}`;

  const { error: uploadError } = await supabase.storage
    .from("product-images")
    .upload(filePath, file, { upsert: false });

  if (uploadError) return showError(uploadError.message);

  const { data } = supabase.storage
    .from("product-images")
    .getPublicUrl(filePath);

  image_url = data.publicUrl;
}


  const { error } = await supabase
    .from("products_min")
    .update({ qty_purchased: newQty })
    .eq("id", id);

  if (error) {
    editMsg.textContent = error.message;
    return;
  }

  await loadStock();
  closeEditModal();
});

function closeEditModal() {
  editOverlay.classList.add("hidden");
  editOverlay.setAttribute("aria-hidden", "true");
  editForm.reset();
  editMsg.textContent = "";
}

closeEditBtn.addEventListener("click", closeEditModal);
cancelEditBtn.addEventListener("click", closeEditModal);

editOverlay.addEventListener("click", (e) => {
  if (e.target === editOverlay) closeEditModal();
});

window.addEventListener("keydown", (e) => {
  if (e.key === "Escape" && !editOverlay.classList.contains("hidden")) closeEditModal();
});

stockBox.addEventListener("click", async (e) => {
  const edit = e.target.closest(".editQtyBtn");
  if (edit) {
    openEditModal({
      id: edit.dataset.id,
      name: edit.dataset.name,
      qty: edit.dataset.qty
    });
    return;
  }

  const del = e.target.closest(".deleteBtn");
  if (del) {
    const id = del.dataset.id;
    const name = del.dataset.name;

    const ok = window.confirm(`Eliminare definitivamente "${name}"?`);
    if (!ok) return;

    const { error } = await supabase
      .from("products_min")
      .delete()
      .eq("id", id);

    if (error) {
      alert(error.message);
      return;
    }

    await loadStock();
  }
});



  function showError(text) {
    msg.textContent = text || "";
    msg.style.color = "#b00020";
  }
  function showOk(text) {
    msg.textContent = text || "";
    msg.style.color = "#0a7a25";
  }

  function openModal() {
    overlay.classList.remove("hidden");
    overlay.setAttribute("aria-hidden", "false");
    showError("");
    setTimeout(() => nameEl.focus(), 0);
  }

  function closeModal() {
    overlay.classList.add("hidden");
    overlay.setAttribute("aria-hidden", "true");
    form.reset();
    showError("");
  }

  addBtn.addEventListener("click", openModal);
  closeModalBtn.addEventListener("click", closeModal);
  cancelBtn.addEventListener("click", closeModal);

  overlay.addEventListener("click", (e) => {
    if (e.target === overlay) closeModal();
  });

  window.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && !overlay.classList.contains("hidden")) closeModal();
  });

  async function loadStock() {
    const { data, error } = await supabase
.from("v_stock")
.select("id,name,image_url,total_paid,qty_total,avg_unit_price,created_at")



      .order("created_at", { ascending: false });

    if (error) {
      stockBox.innerHTML = `<div class="muted">${error.message}</div>`;
      return;
    }

    stockBox.innerHTML = "";

    if (!data.length) {
      stockBox.innerHTML = `<div class="muted">Nessun prodotto</div>`;
      return;
    }

    for (const p of data) {
      const card = document.createElement("div");
      card.className = "card";
const unit = Number(p.avg_unit_price ?? 0);
const placeholder =
  "data:image/svg+xml;utf8," +
  encodeURIComponent(`
    <svg xmlns='http://www.w3.org/2000/svg' width='600' height='360'>
      <rect width='100%' height='100%' fill='#f2f2f2'/>
      <text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle'
            fill='#777' font-family='Arial' font-size='28'>
        No Image
      </text>
    </svg>
  `);

const imgSrc = p.image_url ? p.image_url : placeholder;

card.innerHTML = `
  <h4>${p.name}</h4>
<div class="card-image">
  <img src="${imgSrc}" alt="${p.name}">
</div>


  <div class="card-actions">
    <button class="small-btn editQtyBtn" type="button"
      data-id="${p.id}"
      data-name="${p.name}"
      data-qty="${p.qty_total}">
      ✏️ Quantità
    </button>

    <button class="danger-btn deleteBtn" type="button"
      data-id="${p.id}"
      data-name="${p.name}"
      aria-label="Elimina ${p.name}">
      ✕
    </button>
  </div>
  <div class="row">
    <span>Quantità</span>
    <strong>${p.qty_total}</strong>
  </div>

  <div class="row">
    <span>Prezzo medio unitario</span>
    <strong>€ ${unit.toFixed(2)}</strong>
  </div>

  <div class="row">
    <span>Totale pagato</span>
    <strong>€ ${p.total_paid}</strong>
  </div>

  <div class="muted">Aggiornato il ${new Date(p.created_at).toLocaleString()}</div>
`;


      stockBox.appendChild(card);
    }
  }

form.addEventListener("submit", async (e) => {
  e.preventDefault();
  showError("");

  const name = nameEl.value.trim();
  const price_paid = Number(priceEl.value);
  const qty_purchased = Number(qtyEl.value);

  if (!name) return showError("Inserisci il nome prodotto.");
  if (!Number.isFinite(price_paid) || price_paid < 0) return showError("Prezzo non valido.");
  if (!Number.isFinite(qty_purchased) || qty_purchased <= 0) return showError("Quantità non valida.");

let image_url = null;

if (imageFile.files && imageFile.files.length > 0) {
  const file = imageFile.files[0];
  const ext = (file.name.split(".").pop() || "jpg").toLowerCase();

  // IMPORTANTISSIMO: niente slash iniziale
  const filePath = `products/${crypto.randomUUID()}.${ext}`;

  const { data: upData, error: uploadError } = await supabase.storage
    .from("product-images")
    .upload(filePath, file, { upsert: false, contentType: file.type });

  console.log("UPLOAD RESULT:", upData, uploadError);

  if (uploadError) return showError(uploadError.message);

  const { data: pub } = supabase.storage
    .from("product-images")
    .getPublicUrl(filePath);

  image_url = pub.publicUrl;
}


  // ✅ RPC con image_url ora DEFINITA
  const { error } = await supabase.rpc("add_product_purchase", {
    p_name: name,
    p_price_paid: price_paid,
    p_qty_purchased: qty_purchased,
    p_image_url: image_url
  });

  if (error) return showError(error.message);

  await loadStock();
  closeModal();
});



  // First load
  await loadStock();
  supabase
  .channel("products-live")
  .on(
    "postgres_changes",
    { event: "*", schema: "public", table: "products_min" },
    async () => {
      await loadStock();
    }
  )
  .subscribe();

</script>

</html>
