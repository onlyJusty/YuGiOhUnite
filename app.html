<!doctype html>
<html lang="it">
<head>
  <link rel="icon" type="image/png" href="./images/imgLogo.jpg">

  <link rel="stylesheet" href="./css/style.css">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>YuGiOhUnite Database</title>
</head>

<body>
<header class="topbar">
  <div class="topbar-left">
    <img src="./images/imgLogo.jpg" id="imgLogo" width="100" alt="Logo">
  </div>

  <nav class="topbar-nav">
    <button id="homeBtn" class="navButton">Home</button>
    <button id="listButton" class="navButton">Lista Prodotti</button>
  </nav>

  <button id="addBtn" class="fab" type="button" aria-label="Aggiungi prodotto">+</button>
</header>

  <div id="linea"></div>
<div id="filter">
<div id="Filtri">
  <button id="btnFiltroVenduto"type="button" class="ButtonFilter">STORE</button>
<button id="btnFiltroArchivio" type="button"class="ButtonFilter">VENDUTI</button>
  <button id="btnFiltroTutti"type="button" class="ButtonFilter">TUTTI</button>


</div>




</div>
<main>
  <section class="panel">
    <div id="stockBox" class="cards"></div>
  </section>
</main>

<!-- MODAL EDIT PRODUCT -->
<div id="editOverlay" class="overlay hidden" aria-hidden="true">
  <div class="modal modal-lg" role="dialog" aria-modal="true" aria-labelledby="editTitle">
    <div class="modal-head">
      <h2 id="editTitle">Modifica prodotto</h2>
      <button id="closeEditBtn" class="icon-btn" type="button" aria-label="Chiudi">‚úï</button>
    </div>

    <form id="editForm" class="form">
      <input id="editId" type="hidden" />

      <div class="edit-preview">
        <img id="editImg" alt="Anteprima immagine prodotto" />
      </div>

      <label>
        Nome prodotto
        <input id="editName" type="text" required />
      </label>

      <label>
        Totale pagato
        <input id="editPrice" type="number" step="0.01" min="0" required />
      </label>

      <label>
        Quantit√† totale
        <input id="editQty" type="number" step="0.01" min="0" required />
      </label>

      <label>
        Cambia immagine (opzionale)
        <input id="editImageFile" type="file" accept="image/*" />
      </label>

      <div id="editMsg" class="msg"></div>

      <div class="form-actions">
        <button id="cancelEditBtn" type="button" class="btn">Annulla</button>
        <button type="submit" class="btn primary">Salva</button>
      </div>
    </form>
  </div>
</div>


<!-- MODAL -->
<div id="modalOverlay" class="overlay hidden" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-head">
      <h2 id="modalTitle">Nuovo prodotto</h2>
      <button id="closeModalBtn" class="icon-btn" type="button" aria-label="Chiudi">‚úï</button>
    </div>
    <label>
  Immagine prodotto
  <input id="imageFile" type="file" accept="image/*">
</label>

    <form id="productForm" class="form">
      <label>
        Nome prodotto
        <input id="name" type="text" placeholder="Es. Caff√®" required />
      </label>

      <label>
        Prezzo pagato
        <input id="price" type="number" step="0.01" min="0" placeholder="Es. 12.50" required />
      </label>

      <label>
        Quantit√† acquistata
        <input id="qty" type="number" step="0.01" min="0" placeholder="Es. 5" required />
      </label>

      <div id="formMsg" class="msg"></div>

      <div class="form-actions">
        <button id="cancelBtn" type="button" class="btn">Annulla</button>
        <button id="saveBtn" type="submit" class="btn primary">Salva</button>
      </div>
    </form>
  </div>
</div>

</body>
 <script type="module">
  let currentFilter = "all"; // "all" | "warehouse" | "archive"

  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const SUPABASE_URL = "https://vrxctmrnumkzswdnvjbp.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZyeGN0bXJudW1renN3ZG52amJwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MzM3ODIsImV4cCI6MjA4MjQwOTc4Mn0.FTNv23yGcLvDKKa2hyP9lj2sFeTUB6iFMzU4G_7AUMU";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Require auth
  const { data: { session } } = await supabase.auth.getSession();
  if (!session) window.location.href = "./index.html";

  // DOM
  const stockBox = document.getElementById("stockBox");

  const addBtn = document.getElementById("addBtn");
  const overlay = document.getElementById("modalOverlay");
  const closeModalBtn = document.getElementById("closeModalBtn");
  const cancelBtn = document.getElementById("cancelBtn");
const btnFiltroTutti = document.getElementById("btnFiltroTutti");
const btnFiltroVenduto = document.getElementById("btnFiltroVenduto");   // MAGAZZINO
const btnFiltroArchivio = document.getElementById("btnFiltroArchivio"); // ARCHIVIO

btnFiltroTutti.addEventListener("click", async () => {
  currentFilter = "all";

updateFilterUI();


  await loadStock();
});

btnFiltroVenduto.addEventListener("click", async () => {
  currentFilter = "warehouse";
  updateFilterUI();
  await loadStock();
});

btnFiltroArchivio.addEventListener("click", async () => {
  currentFilter = "archive";

updateFilterUI();


  await loadStock();
});

  const form = document.getElementById("productForm");
  const msg = document.getElementById("formMsg");

  const nameEl = document.getElementById("name");
  const priceEl = document.getElementById("price");
  const qtyEl = document.getElementById("qty");

const editOverlay = document.getElementById("editOverlay");
const closeEditBtn = document.getElementById("closeEditBtn");
const cancelEditBtn = document.getElementById("cancelEditBtn");
const editForm = document.getElementById("editForm");

const editId = document.getElementById("editId");
const editName = document.getElementById("editName");
const editPrice = document.getElementById("editPrice");
const editQty = document.getElementById("editQty");
const editImg = document.getElementById("editImg");
const editImageFile = document.getElementById("editImageFile");
const editMsg = document.getElementById("editMsg");

const IMG_PLACEHOLDER =
  "data:image/svg+xml;utf8," +
  encodeURIComponent(`
    <svg xmlns='http://www.w3.org/2000/svg' width='600' height='360'>
      <rect width='100%' height='100%' fill='#f2f2f2'/>
      <text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle'
            fill='#777' font-family='Arial' font-size='28'>
        No Image
      </text>
    </svg>
  `);



const imageFile = document.getElementById("imageFile");

function openEditModal({ id, name, qty, total, img }) {
  editOverlay.classList.remove("hidden");
  editOverlay.setAttribute("aria-hidden", "false");
  editMsg.textContent = "";

  editId.value = id;
  editName.value = name;
  editQty.value = qty;
  editPrice.value = total;

  editImg.src = img && img.length ? img : IMG_PLACEHOLDER;
  editImageFile.value = "";

  setTimeout(() => editName.focus(), 0);
}



closeEditBtn.addEventListener("click", closeEditModal);
cancelEditBtn.addEventListener("click", closeEditModal);

editOverlay.addEventListener("click", (e) => {
  if (e.target === editOverlay) closeEditModal();
});

window.addEventListener("keydown", (e) => {
  if (e.key === "Escape" && !editOverlay.classList.contains("hidden")) closeEditModal();
});


editForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  editMsg.textContent = "";

  const id = editId.value;
  const newQty = Number(editQty.value);

  if (!id) {
    editMsg.textContent = "ID mancante.";
    return;
  }
  if (!Number.isFinite(newQty) || newQty < 0) {
    editMsg.textContent = "Quantit√† non valida.";
    return;
  }
//eccoeccoecco
let image_url = null;

if (imageFile.files.length > 0) {
  const file = imageFile.files[0];
  const ext = file.name.split(".").pop() || "jpg";
  const filePath = `products/${crypto.randomUUID()}.${ext}`;

  const { error: uploadError } = await supabase.storage
    .from("product-images")
    .upload(filePath, file, { upsert: false });

  if (uploadError) return showError(uploadError.message);

  const { data } = supabase.storage
    .from("product-images")
    .getPublicUrl(filePath);

  image_url = data.publicUrl;
}


  const { error } = await supabase
    .from("products_min")
    .update({ qty_purchased: newQty })
    .eq("id", id);

  if (error) {
    editMsg.textContent = error.message;
    return;
  }

  await loadStock();
  closeEditModal();
});

function closeEditModal() {
  editOverlay.classList.add("hidden");
  editOverlay.setAttribute("aria-hidden", "true");
  editForm.reset();
  editMsg.textContent = "";
}

closeEditBtn.addEventListener("click", closeEditModal);
cancelEditBtn.addEventListener("click", closeEditModal);

editOverlay.addEventListener("click", (e) => {
  if (e.target === editOverlay) closeEditModal();
});

window.addEventListener("keydown", (e) => {
  if (e.key === "Escape" && !editOverlay.classList.contains("hidden")) closeEditModal();
});

stockBox.addEventListener("click", async (e) => {
  const edit = e.target.closest(".editBtn");
  if (edit) {
    openEditModal({
      id: edit.dataset.id,
      name: edit.dataset.name,
      qty: edit.dataset.qty,
      total: edit.dataset.total,
      img: edit.dataset.img
    });
    return;
  }

  const del = e.target.closest(".deleteBtn");
  if (del) {
    const ok = window.confirm(`Eliminare definitivamente "${del.dataset.name}"?`);
    if (!ok) return;

    const { error } = await supabase.from("products_min").delete().eq("id", del.dataset.id);
    if (error) return alert(error.message);

    await loadStock();
  }
});




  function showError(text) {
    msg.textContent = text || "";
    msg.style.color = "#b00020";
  }
  function showOk(text) {
    msg.textContent = text || "";
    msg.style.color = "#0a7a25";
  }

  function openModal() {
    overlay.classList.remove("hidden");
    overlay.setAttribute("aria-hidden", "false");
    showError("");
    setTimeout(() => nameEl.focus(), 0);
  }

  function closeModal() {
    overlay.classList.add("hidden");
    overlay.setAttribute("aria-hidden", "true");
    form.reset();
    showError("");
  }
editForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  editMsg.textContent = "";

  const id = editId.value;
  const name = editName.value.trim();
  const total_paid = Number(editPrice.value);
  const qty_total = Number(editQty.value);

  if (!id) return (editMsg.textContent = "ID mancante.");
  if (!name) return (editMsg.textContent = "Nome obbligatorio.");
  if (!Number.isFinite(total_paid) || total_paid < 0) return (editMsg.textContent = "Totale pagato non valido.");
  if (!Number.isFinite(qty_total) || qty_total < 0) return (editMsg.textContent = "Quantit√† non valida.");

  // Upload nuova immagine (se scelta)
  let image_url = null;
  if (editImageFile.files && editImageFile.files.length > 0) {
    const file = editImageFile.files[0];
    const ext = (file.name.split(".").pop() || "jpg").toLowerCase();
    const filePath = `${session.user.id}/products/${crypto.randomUUID()}.${ext}`;

    const { error: upErr } = await supabase.storage
      .from("product-images")
      .upload(filePath, file, { upsert: false, contentType: file.type });

    if (upErr) return (editMsg.textContent = upErr.message);

    const { data: pub } = supabase.storage.from("product-images").getPublicUrl(filePath);
    image_url = pub.publicUrl;
  }

  const patch = { name, price_paid: total_paid, qty_purchased: qty_total };
  if (image_url) patch.image_url = image_url;

  const { error } = await supabase.from("products_min").update(patch).eq("id", id);
  if (error) return (editMsg.textContent = error.message); // qui vedi anche errore duplicate name

  await loadStock();
  closeEditModal();
});
stockBox.addEventListener("change", async (e) => {
  const sale = e.target.closest(".saleCheckbox");
  const delivered = e.target.closest(".deliveredCheckbox");
  if (!sale && !delivered) return;

  const id = e.target.dataset.id;

  // trova entrambe le checkbox della stessa card
  const card = e.target.closest(".card");
  const saleEl = card.querySelector(".saleCheckbox");
  const delEl = card.querySelector(".deliveredCheckbox");

  // stato richiesto
  let in_vendita = saleEl.checked;
  let consegnato = delEl.checked;

  // UX: se consegnato=true allora in_vendita=false (coerente)
  if (consegnato) {
    in_vendita = false;
    saleEl.checked = false;
  }

  // blocca input mentre salva
  saleEl.disabled = true;
  delEl.disabled = true;

  const { error } = await supabase.rpc("set_product_status", {
    p_product_id: id,
    p_in_vendita: in_vendita,
    p_consegnato: consegnato
  });

  saleEl.disabled = false;
  delEl.disabled = false;

  if (error) {
    alert(error.message);
    // rollback UI (ricarichiamo)
    await loadStock();
    return;
  }

  // opzionale: non serve ricaricare tutto, ma per ora √® ok
  await loadStock();
});

  addBtn.addEventListener("click", openModal);
  closeModalBtn.addEventListener("click", closeModal);
  cancelBtn.addEventListener("click", closeModal);
function updateFilterUI() {
  btnFiltroTutti.classList.toggle("active", currentFilter === "all");
  btnFiltroVenduto.classList.toggle("active", currentFilter === "warehouse");
  btnFiltroArchivio.classList.toggle("active", currentFilter === "archive");
}

  overlay.addEventListener("click", (e) => {
    if (e.target === overlay) closeModal();
  });

  window.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && !overlay.classList.contains("hidden")) closeModal();
  });

  async function loadStock() {
let q = supabase
  .from("v_stock")
  .select("id,name,image_url,in_vendita,consegnato,total_paid,qty_total,avg_unit_price,created_at");

if (currentFilter === "warehouse") {
  q = q.eq("consegnato", false);
} else if (currentFilter === "archive") {
  q = q.eq("consegnato", true);
}

const { data, error } = await q.order("created_at", { ascending: false });


    if (error) {
      stockBox.innerHTML = `<div class="muted">${error.message}</div>`;
      return;
    }

    stockBox.innerHTML = "";

    if (!data.length) {
      stockBox.innerHTML = `<div class="muted">Nessun prodotto</div>`;
      return;
    }

    for (const p of data) {
      const card = document.createElement("div");
      card.className = "card";
const unit = Number(p.avg_unit_price ?? 0);
const placeholder =
  "data:image/svg+xml;utf8," +
  encodeURIComponent(`
    <svg xmlns='http://www.w3.org/2000/svg' width='600' height='360'>
      <rect width='100%' height='100%' fill='#f2f2f2'/>
      <text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle'
            fill='#777' font-family='Arial' font-size='28'>
        No Image
      </text>
    </svg>
  `);

const imgSrc = p.image_url ? p.image_url : placeholder;

card.innerHTML = `
  <h4>${p.name}</h4>
${p.consegnato ? `<div class="badge-venduto">VENDUTO</div>` : ""}

  <div class="card-image">
    <img src="${imgSrc}" alt="${p.name}">
  </div>

<div class="card-actions under-image">

  <!-- RIGA 1: AZIONI -->
  <div class="card-actions-row">
    <button class="small-btn editBtn" type="button"
      data-id="${p.id}"
      data-name="${p.name}"
      data-qty="${p.qty_total}"
      data-total="${p.total_paid}"
      data-img="${p.image_url || ""}">
      ‚úèÔ∏è Modifica
    </button>

    <button class="danger-btn deleteBtn" type="button"
      data-id="${p.id}"
      data-name="${p.name}"
      aria-label="Elimina ${p.name}">
      üóëÔ∏è
    </button>
  </div>

  <!-- RIGA 2: STATI -->
  <div class="card-status-row">
    <label class="card-check">
      <input type="checkbox"
        class="saleCheckbox"
        data-id="${p.id}"
        ${p.in_vendita ? "checked" : ""}>
      <span>Caricato</span>
    </label>

    <label class="card-check">
      <input type="checkbox"
        class="deliveredCheckbox"
        data-id="${p.id}"
        ${p.consegnato ? "checked" : ""}>
      <span>Venduto</span>
    </label>
  </div>

</div>







  </div>
  <div class="row">
    <span>Quantit√†</span>
    <strong>${p.qty_total}</strong>
  </div>

  <div class="row">
    <span>Prezzo medio unitario</span>
    <strong>‚Ç¨ ${unit.toFixed(2)}</strong>
  </div>

  <div class="row">
    <span>Totale pagato</span>
    <strong>‚Ç¨ ${p.total_paid}</strong>
  </div>

  <div class="muted">Aggiornato il ${new Date(p.created_at).toLocaleString()}</div>
`;


      stockBox.appendChild(card);
    }
  }

form.addEventListener("submit", async (e) => {
  e.preventDefault();
  showError("");

  const name = nameEl.value.trim();
  const price_paid = Number(priceEl.value);
  const qty_purchased = Number(qtyEl.value);

  if (!name) return showError("Inserisci il nome prodotto.");
  if (!Number.isFinite(price_paid) || price_paid < 0) return showError("Prezzo non valido.");
  if (!Number.isFinite(qty_purchased) || qty_purchased <= 0) return showError("Quantit√† non valida.");

let image_url = null;

if (imageFile.files && imageFile.files.length > 0) {
  const file = imageFile.files[0];
  const ext = (file.name.split(".").pop() || "jpg").toLowerCase();

  // IMPORTANTISSIMO: niente slash iniziale
  const filePath = `products/${crypto.randomUUID()}.${ext}`;

  const { data: upData, error: uploadError } = await supabase.storage
    .from("product-images")
    .upload(filePath, file, { upsert: false, contentType: file.type });

  console.log("UPLOAD RESULT:", upData, uploadError);

  if (uploadError) return showError(uploadError.message);

  const { data: pub } = supabase.storage
    .from("product-images")
    .getPublicUrl(filePath);

  image_url = pub.publicUrl;
}


  // ‚úÖ RPC con image_url ora DEFINITA
  const { error } = await supabase.rpc("add_product_purchase", {
    p_name: name,
    p_price_paid: price_paid,
    p_qty_purchased: qty_purchased,
    p_image_url: image_url
  });

  if (error) return showError(error.message);

  await loadStock();
  closeModal();
});

  currentFilter = "warehouse";
updateFilterUI();

  // First load
  await loadStock();
  supabase
  .channel("products-live")
  .on(
    "postgres_changes",
    { event: "*", schema: "public", table: "products_min" },
    async () => {
      await loadStock();
    }
  )
  .subscribe();

</script>

</html>